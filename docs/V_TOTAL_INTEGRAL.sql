DROP PROCEDURE `V_TOTAL_INTEGRAL`//
CREATE DEFINER=`root`@`localhost` PROCEDURE `V_TOTAL_INTEGRAL`()
BEGIN 
	/** CALL V_TOTAL_INTEGRAL(); */
	DECLARE KILLER_RANKING INT DEFAULT 0;
	DECLARE DETECTIVE_RANKING INT DEFAULT 0;
	DECLARE PEOPLE_RANKING INT DEFAULT 0;

	(
		SELECT 
		F1_A802 AS 'USER_ID',
		OTIME,
		SUM(F2_A802) AS SUM_INTEGRAL 
		FROM A_802 
		WHERE F6_A802 = 2
		GROUP BY F1_A802 
		ORDER BY SUM_INTEGRAL DESC,OTIME DESC
		LIMIT 3
	) UNION ALL
	(
		SELECT 
		F1_A802 AS 'USER_ID',
		OTIME,
		SUM(F2_A802) AS SUM_INTEGRAL 
		FROM A_802 
		WHERE F6_A802 = 3
		GROUP BY F1_A802 
		ORDER BY SUM_INTEGRAL DESC,OTIME DESC
		LIMIT 3
	) UNION ALL
	(
		SELECT 
		F1_A802 AS 'USER_ID',
		OTIME,
		SUM(F2_A802) AS SUM_INTEGRAL 
		FROM A_802 
		WHERE F6_A802 = 4
		GROUP BY F1_A802 
		ORDER BY SUM_INTEGRAL DESC,OTIME DESC
		LIMIT 3
	) UNION ALL
	(
		SELECT 
		F1_A802 AS 'USER_ID',
		OTIME,
		SUM(F2_A802) AS SUM_INTEGRAL 
		FROM A_802 
		GROUP BY F1_A802 
		ORDER BY SUM_INTEGRAL DESC,OTIME DESC
		LIMIT 3
	)



	SELECT 0 AS 'SYSTEM_USERID','unknow' AS 'SYSTEM_USERNAME',
	(SELECT IFNULL(SUM(F5_A404),0) AS 'LEND_MONEY' FROM A_201,A_404 WHERE oid_A201 = F2_A404 AND F15_A201 = 0 AND F8_A404 = 1 AND F9_A404 = 0 AND F1_A404 IN(SELECT oid_A401 FROM A_401 WHERE F10_A401 >=70) AND DATE_FORMAT(F10_A404,'%Y-%m') = '$year-$month') AS 'LEND_MONEY',
	(SELECT IFNULL(SUM(F5_A404),0) AS 'TRANS_MONEY' FROM A_201,A_404 WHERE oid_A201 = F2_A404 AND F15_A201 = 0 AND F8_A404 = 2 AND F9_A404 = 0 AND F1_A404 IN(SELECT oid_A401 FROM A_401 WHERE F10_A401 >=70) AND DATE_FORMAT(F10_A404,'%Y-%m') = '$year-$month') AS 'TRANS_MONEY',
	(SELECT IFNULL(SUM(F7_A503),0) AS 'FUND_MONEY' FROM A_201,A_503 WHERE oid_A201 = F2_A503 AND F15_A201 = 0 AND F1_A503 IN(SELECT oid_A501 FROM A_501 WHERE F10_A501 >= 50) AND DATE_FORMAT(F8_A503,'%Y-%m') = '$year-$month') AS 'FUND_MONEY'
	UNION ALL
	SELECT oid_A101,F1_A101,IFNULL(LEND_MONEY,0.00),IFNULL(TRANS_MONEY,0.00),IFNULL(FUND_MONEY,0.00) FROM A_101
	LEFT JOIN(SELECT F15_A201,SUM(F5_A404) AS 'LEND_MONEY' FROM A_201,A_404 WHERE oid_A201 = F2_A404 AND F15_A201 > 0 AND F8_A404 = 1 AND F9_A404 = 0 AND F1_A404 IN(SELECT oid_A401 FROM A_401 WHERE F10_A401 >=70) AND DATE_FORMAT(F10_A404,'%Y-%m') = '$year-$month' GROUP BY F15_A201) AS table1 ON A_101.oid_A101 = table1.F15_A201
	LEFT JOIN(SELECT F15_A201,SUM(F5_A404) AS 'TRANS_MONEY' FROM A_201,A_404 WHERE oid_A201 = F2_A404 AND F15_A201 > 0 AND F8_A404 = 2 AND F9_A404 = 0 AND F1_A404 IN(SELECT oid_A401 FROM A_401 WHERE F10_A401 >=70) AND DATE_FORMAT(F10_A404,'%Y-%m') = '$year-$month' GROUP BY F15_A201) AS table2 ON A_101.oid_A101 = table2.F15_A201
	LEFT JOIN(SELECT F15_A201,SUM(F7_A503) AS 'FUND_MONEY' FROM A_201,A_503 WHERE oid_A201 = F2_A503 AND F15_A201 > 0 AND F1_A503 IN(SELECT oid_A501 FROM A_501 WHERE F10_A501 >= 50) AND DATE_FORMAT(F8_A503,'%Y-%m') = '$year-$month' GROUP BY F15_A201) AS table3 ON A_101.oid_A101 = table3.F15_A201
	ORDER BY LEND_MONEY+TRANS_MONEY+FUND_MONEY DESC, SYSTEM_USERID ASC
	
END